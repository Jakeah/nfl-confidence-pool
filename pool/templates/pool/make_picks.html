{% extends 'pool/base.html' %}
{% load pool_extras %}

{% block title %}Make Picks - Week {{ week.week_number }} - NFL Confidence Pool{% endblock %}

{% block extra_css %}
<style>
    .game-card {
        margin-bottom: 16px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }
    .game-header {
        background-color: #f5f5f5;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e0e0e0;
    }
    .game-body {
        padding: 16px;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        align-items: center;
    }
    .team-choices {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .team-choice {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .team-choice:hover {
        background-color: #f5f5f5;
        border-color: #013369;
    }
    .team-choice input[type="radio"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    .team-choice label {
        flex: 1;
        cursor: pointer;
        font-size: 16px;
    }
    .confidence-input-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .confidence-input {
        width: 100px;
        height: 80px;
        font-size: 32px;
        font-weight: 500;
        text-align: center;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
    }
    .confidence-input:focus {
        outline: none;
        border-color: #013369;
    }
    .bears-alert {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 16px;
        margin-bottom: 24px;
        border-radius: 4px;
    }
    .section-card {
        margin-bottom: 24px;
    }
    @media (max-width: 768px) {
        .game-body {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="mdc-typography--headline4" style="margin-bottom: 8px; color: #013369;">
    Make Your Picks
</div>
<div class="mdc-typography--headline6" style="margin-bottom: 24px; color: #666;">
    {{ week }}
</div>

<div class="bears-alert">
    <div style="display: flex; align-items: center; gap: 12px;">
        <i class="material-icons" style="color: #ff9800; font-size: 32px;">warning</i>
        <div>
            <div style="font-weight: 500; margin-bottom: 4px;">REMEMBER: Chicago Bears Rule</div>
            <div style="font-size: 14px;">You MUST pick the Chicago Bears to win their game!</div>
        </div>
    </div>
</div>

<div class="mdc-card" style="padding: 16px; margin-bottom: 24px;">
    <div style="display: flex; align-items: center; gap: 8px; color: #666;">
        <i class="material-icons">schedule</i>
        <span><strong>Picks Deadline:</strong> {{ week.picks_deadline|date:"F d, Y g:i A" }}</span>
    </div>
</div>

<!-- Confidence Picks Section -->
<div class="mdc-card section-card" style="padding: 24px;">
    <h2 class="mdc-typography--headline5" style="margin-bottom: 8px;">
        <i class="material-icons" style="vertical-align: middle;">sports_football</i>
        Confidence Picks
    </h2>
    <p class="mdc-typography--body2" style="color: #666; margin-bottom: 24px;">
        Assign confidence points from 1 to {{ games.count }}. Higher = more confident. Each game must have a unique value.
    </p>

    <form method="post" id="picks-form">
        {% csrf_token %}

        {% if confidence_form.non_field_errors %}
            <div style="padding: 16px; background-color: #ffebee; color: #c62828; border-radius: 4px; margin-bottom: 16px;">
                {{ confidence_form.non_field_errors }}
            </div>
        {% endif %}

        {% for game in games %}
            {% if game.home_team.id == bears_team.id or game.away_team.id == bears_team.id %}
                {# Bears game - auto-select Bears and disable #}
                <div class="game-card" style="border-left: 4px solid #ffc107;">
                    <div class="game-header" style="background-color: #fff9e6;">
                        <div>
                            <strong>{{ game.away_team.abbreviation }} @ {{ game.home_team.abbreviation }}</strong>
                            <span style="margin-left: 8px; background-color: #ffc107; color: #000; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold;">BEARS - AUTO-SELECTED</span>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <i class="material-icons" style="font-size: 14px; vertical-align: middle;">event</i>
                            {{ game.game_time|date:"l, M d - g:i A" }}
                        </div>
                    </div>
                    <div class="game-body">
                        <div class="team-choices" style="pointer-events: none; cursor: not-allowed;">
                            <div class="team-choice" style="{% if game.home_team.id == bears_team.id %}border-color: #013369; background-color: #e8f4f8;{% else %}opacity: 0.5;{% endif %}">
                                <input type="radio"
                                       name="game_{{ game.id }}_team"
                                       value="{{ game.home_team.id }}"
                                       id="game_{{ game.id }}_home"
                                       {% if game.home_team.id == bears_team.id %}checked{% endif %}
                                       required>
                                <label for="game_{{ game.id }}_home" style="cursor: not-allowed;">
                                    {{ game.home_team.abbreviation }} (Home) {% if game.home_team.id == bears_team.id %}üêª{% endif %}
                                </label>
                            </div>

                            <div class="team-choice" style="{% if game.away_team.id == bears_team.id %}border-color: #013369; background-color: #e8f4f8;{% else %}opacity: 0.5;{% endif %}">
                                <input type="radio"
                                       name="game_{{ game.id }}_team"
                                       value="{{ game.away_team.id }}"
                                       id="game_{{ game.id }}_away"
                                       {% if game.away_team.id == bears_team.id %}checked{% endif %}
                                       required>
                                <label for="game_{{ game.id }}_away" style="cursor: not-allowed;">
                                    {{ game.away_team.abbreviation }} (Away) {% if game.away_team.id == bears_team.id %}üêª{% endif %}
                                </label>
                            </div>
                        </div>
                        <div class="confidence-input-wrapper">
                            <label style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500;">
                                Confidence
                            </label>
                            <input type="number"
                                   name="game_{{ game.id }}_confidence"
                                   class="confidence-input"
                                   min="1"
                                   max="{{ games.count }}"
                                   value="{% if game.id in existing_picks %}{% with existing_picks|get_item:game.id as pick %}{{ pick.confidence }}{% endwith %}{% endif %}"
                                   required>
                        </div>
                    </div>
                </div>
            {% else %}
                {# Regular game #}
                <div class="game-card">
                    <div class="game-header">
                        <div>
                            <strong>{{ game.away_team.abbreviation }} @ {{ game.home_team.abbreviation }}</strong>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <i class="material-icons" style="font-size: 14px; vertical-align: middle;">event</i>
                            {{ game.game_time|date:"l, M d - g:i A" }}
                        </div>
                    </div>
                    <div class="game-body">
                        <div class="team-choices">
                            <div class="team-choice">
                                <input type="radio"
                                       name="game_{{ game.id }}_team"
                                       value="{{ game.home_team.id }}"
                                       id="game_{{ game.id }}_home"
                                       {% if game.id in existing_picks %}{% with existing_picks|get_item:game.id as pick %}{% if pick.team_id == game.home_team.id %}checked{% endif %}{% endwith %}{% endif %}
                                       required>
                                <label for="game_{{ game.id }}_home">
                                    {{ game.home_team.abbreviation }} (Home)
                                </label>
                            </div>

                            <div class="team-choice">
                                <input type="radio"
                                       name="game_{{ game.id }}_team"
                                       value="{{ game.away_team.id }}"
                                       id="game_{{ game.id }}_away"
                                       {% if game.id in existing_picks %}{% with existing_picks|get_item:game.id as pick %}{% if pick.team_id == game.away_team.id %}checked{% endif %}{% endwith %}{% endif %}
                                       required>
                                <label for="game_{{ game.id }}_away">
                                    {{ game.away_team.abbreviation }} (Away)
                                </label>
                            </div>
                        </div>
                        <div class="confidence-input-wrapper">
                            <label style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500;">
                                Confidence
                            </label>
                            <input type="number"
                                   name="game_{{ game.id }}_confidence"
                                   class="confidence-input"
                                   min="1"
                                   max="{{ games.count }}"
                                   value="{% if game.id in existing_picks %}{% with existing_picks|get_item:game.id as pick %}{{ pick.confidence }}{% endwith %}{% endif %}"
                                   required>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
</div>

<!-- Survivor Pool Section -->
{% if not user_stats.is_eliminated_survivor %}
<div class="mdc-card section-card" style="padding: 24px;">
    <h2 class="mdc-typography--headline5" style="margin-bottom: 8px;">
        <i class="material-icons" style="vertical-align: middle;">shield</i>
        Survivor Pool
    </h2>
    <div style="display: flex; gap: 24px; margin-bottom: 24px; flex-wrap: wrap;">
        <div>
            <div style="font-size: 12px; color: #666;">This Week</div>
            <div style="font-size: 24px; font-weight: 500; color: #013369;">
                {{ week.survivor_picks_required }}
                {% if week.survivor_picks_required == 1 %}Pick{% else %}Picks{% endif %}
                {% if week.week_number|divisibleby:2 %}
                    <span style="font-size: 14px; color: #666;">(Even week)</span>
                {% else %}
                    <span style="font-size: 14px; color: #666;">(Odd week)</span>
                {% endif %}
            </div>
        </div>
        <div>
            <div style="font-size: 12px; color: #666;">Your Strikes</div>
            {% if user_stats.survivor_strikes >= 2 %}
                <div style="font-size: 24px; font-weight: 500; color: #f44336;">
                    {{ user_stats.survivor_strikes }}/3
                </div>
            {% elif user_stats.survivor_strikes == 1 %}
                <div style="font-size: 24px; font-weight: 500; color: #ff9800;">
                    {{ user_stats.survivor_strikes }}/3
                </div>
            {% else %}
                <div style="font-size: 24px; font-weight: 500; color: #4caf50;">
                    {{ user_stats.survivor_strikes }}/3
                </div>
            {% endif %}
        </div>
    </div>
    <p class="mdc-typography--body2" style="color: #666; margin-bottom: 24px;">
        <i class="material-icons" style="font-size: 16px; vertical-align: middle;">info</i>
        You cannot reuse teams you've already picked this season.
    </p>

    {% if survivor_form.non_field_errors %}
        <div style="padding: 16px; background-color: #ffebee; color: #c62828; border-radius: 4px; margin-bottom: 16px;">
            {{ survivor_form.non_field_errors %}
        </div>
    {% endif %}

    {% for field in survivor_form %}
        <div style="margin-bottom: 24px;">
            <label class="mdc-typography--subtitle1" style="display: block; margin-bottom: 8px; font-weight: 500;">
                {{ field.label }}
            </label>
            <select name="{{ field.name }}" id="{{ field.id_for_label }}" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 16px;">
                {% for choice_value, choice_label in field.field.choices %}
                    <option value="{{ choice_value }}" {% if field.value|stringformat:"s" == choice_value|stringformat:"s" %}selected{% endif %}>{{ choice_label }}</option>
                {% endfor %}
            </select>
            {% if field.errors %}
                <div style="color: #f44336; font-size: 12px; margin-top: 8px;">
                    {{ field.errors }}
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- Single Submit Button -->
<button type="submit" form="picks-form" class="mdc-button mdc-button--raised nfl-red" style="width: 100%; padding: 16px; font-size: 16px; margin-top: 24px;">
    <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
    <span class="mdc-button__label">Save All Picks</span>
</button>

</form>

{% endblock %}
